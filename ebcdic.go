// This file is part of https://github.com/racingmars/go3270/
// Copyright 2020 by Matthew R. Wilson, licensed under the MIT license. See
// LICENSE in the project root for license information.

package go3270

import (
	"strings"
)

const sub = 0xfffd
const subS = "ï¿½"

// Each index in this array is the UTF-8 value, and the value at the index is
// the corresponding EBCDIC (codepage 37) / APL (codepage 310) value.
var encoder = map[string][]byte{
	"\x00": {0x00}, "\x01": {0x01}, "\x02": {0x02}, "\x03": {0x03},
	"\x04": {0x37}, "\x05": {0x2d}, "\x06": {0x2e}, "\x07": {0x2f},
	"\x08": {0x16}, "\x09": {0x05}, "\x0a": {0x15}, "\x0b": {0x0b},
	"\x0c": {0x0c}, "\x0d": {0x0d}, "\x0e": {0x0e}, "\x0f": {0x0f},

	"\x10": {0x10}, "\x11": {0x11}, "\x12": {0x12}, "\x13": {0x13},
	"\x14": {0x3c}, "\x15": {0x3d}, "\x16": {0x32}, "\x17": {0x26},
	"\x18": {0x18}, "\x19": {0x19}, "\x1a": {0x3f}, "\x1b": {0x27},
	"\x1c": {0x1c}, "\x1d": {0x1d}, "\x1e": {0x1e}, "\x1f": {0x1f},

	"\x7f": {0x07},

	"\x80": {0x20}, "\x81": {0x21}, "\x82": {0x22}, "\x83": {0x23},
	"\x84": {0x24}, "\x85": {0x25}, "\x86": {0x06}, "\x87": {0x17},
	"\x88": {0x28}, "\x89": {0x29}, "\x8a": {0x2a}, "\x8b": {0x2b},
	"\x8c": {0x2c}, "\x8d": {0x09}, "\x8e": {0x0a}, "\x8f": {0x1b},

	"\x90": {0x30}, "\x91": {0x31}, "\x92": {0x1a}, "\x93": {0x33},
	"\x94": {0x34}, "\x95": {0x35}, "\x96": {0x36}, "\x97": {0x08},
	"\x98": {0x38}, "\x99": {0x39}, "\x9a": {0x3a}, "\x9b": {0x3b},
	"\x9c": {0x04}, "\x9d": {0x14}, "\x9e": {0x3e}, "\x9f": {0xff},

	 " ": {0x40}, "Â ": {0x41},    "Ã¢": {0x42},  "Ã¤": {0x43},
	 "Ã ": {0x44}, "Ã¡": {0x45},    "Ã£": {0x46},  "Ã¥": {0x47},
	 "Ã§": {0x48}, "Ã±": {0x49},    "Â¢": {0x4a},  ".": {0x4b},
	 "<": {0x4c}, "(": {0x4d},    "+": {0x4e},  "|": {0x4f},

	 "&": {0x50}, "Ã©": {0x51},    "Ãª": {0x52},  "Ã«": {0x53},
	 "Ã¨": {0x54}, "Ã­": {0x55},    "Ã®": {0x56},  "Ã¯": {0x57},
	 "Ã¬": {0x58}, "ÃŸ": {0x59},    "!": {0x5a},  "$": {0x5b},
	 "*": {0x5c}, ")": {0x5d},    ";": {0x5e},  "Â¬": {0x5f},

	 "-": {0x60}, "/": {0x61},    "Ã‚": {0x62},  "Ã„": {0x63},
	 "Ã€": {0x64}, "Ã": {0x65},    "Ãƒ": {0x66},  "Ã…": {0x67},
	 "Ã‡": {0x68}, "Ã‘": {0x69},    "Â¦": {0x6a},  ",": {0x6b},
	 "%": {0x6c}, "_": {0x6d},    ">": {0x6e},  "?": {0x6f},

	 "Ã¸": {0x70}, "Ã‰": {0x71},    "ÃŠ": {0x72},  "Ã‹": {0x73},
	 "Ãˆ": {0x74}, "Ã": {0x75},    "Ã": {0x76},  "Ã": {0x77},
	 "ÃŒ": {0x78}, "`": {0x79},    ":": {0x7a},  "#": {0x7b},
	 "@": {0x7c}, "'": {0x7d},    "=": {0x7e}, "\"": {0x7f},

	 "Ã˜": {0x80}, "a": {0x81},    "b": {0x82},  "c": {0x83},
	 "d": {0x84}, "e": {0x85},    "f": {0x86},  "g": {0x87},
	 "h": {0x88}, "i": {0x89},    "Â«": {0x8a},  "Â»": {0x8b},
	 "Ã°": {0x8c}, "Ã½": {0x8d},    "Ã¾": {0x8e},  "Â±": {0x8f},

	 "Â°": {0x90}, "j": {0x91},    "k": {0x92},  "l": {0x93},
	 "m": {0x94}, "n": {0x95},    "o": {0x96},  "p": {0x97},
	 "q": {0x98}, "r": {0x99},    "Âª": {0x9a},  "Âº": {0x9b},
	 "Ã¦": {0x9c}, "Â¸": {0x9d},    "Ã†": {0x9e},  "Â¤": {0x9f},

	 "Âµ": {0xa0}, "~": {0xa1},    "s": {0xa2},  "t": {0xa3},
	 "u": {0xa4}, "v": {0xa5},    "w": {0xa6},  "x": {0xa7},
	 "y": {0xa8}, "z": {0xa9},    "Â¡": {0xaa},  "Â¿": {0xab},
	 "Ã": {0xac}, "Ã": {0xad},    "Ã": {0xae},  "Â®": {0xaf},

	 "^": {0xb0}, "Â£": {0xb1},    "Â¥": {0xb2},  "Â·": {0xb3},
	 "Â©": {0xb4}, "Â§": {0xb5},    "Â¶": {0xb6},  "Â¼": {0xb7},
	 "Â½": {0xb8}, "Â¾": {0xb9},    "[": {0xba},  "]": {0xbb},
	 "Â¯": {0xbc}, "Â¨": {0xbd},    "Â´": {0xbe},  "Ã—": {0xbf},

	 "{": {0xc0}, "A": {0xc1},    "B": {0xc2},  "C": {0xc3},
	 "D": {0xc4}, "E": {0xc5},    "F": {0xc6},  "G": {0xc7},
	 "H": {0xc8}, "I": {0xc9}, "\xad": {0xca},  "Ã´": {0xcb},
	 "Ã¶": {0xcc}, "Ã²": {0xcd},    "Ã³": {0xce},  "Ãµ": {0xcf},

	 "}": {0xd0}, "J": {0xd1},    "K": {0xd2},  "L": {0xd3},
	 "M": {0xd4}, "N": {0xd5},    "O": {0xd6},  "P": {0xd7},
	 "Q": {0xd8}, "R": {0xd9},    "Â¹": {0xda},  "Ã»": {0xdb},
	 "Ã¼": {0xdc}, "Ã¹": {0xdd},    "Ãº": {0xde},  "Ã¿": {0xdf},

	"\\": {0xe0}, "Ã·": {0xe1},    "S": {0xe2},  "T": {0xe3},
	 "U": {0xe4}, "V": {0xe5},    "W": {0xe6},  "X": {0xe7},
	 "Y": {0xe8}, "Z": {0xe9},    "Â²": {0xea},  "Ã”": {0xeb},
	 "Ã–": {0xec}, "Ã’": {0xed},    "Ã“": {0xee},  "Ã•": {0xef},

	 "0": {0xf0}, "1": {0xf1},    "2": {0xf2},  "3": {0xf3},
	 "4": {0xf4}, "5": {0xf5},    "6": {0xf6},  "7": {0xf7},
	 "8": {0xf8}, "9": {0xf9},    "Â³": {0xfa},  "Ã›": {0xfb},
	 "Ãœ": {0xfc}, "Ã™": {0xfd},    "Ãš": {0xfe},

	                   "ğ´Ì²": {0x08, 0x41}, "ğµÌ²": {0x08, 0x42}, "ğ¶Ì²": {0x08, 0x43},
	"ğ·Ì²": {0x08, 0x44}, "ğ¸Ì²": {0x08, 0x45}, "ğ¹Ì²": {0x08, 0x46}, "ğºÌ²": {0x08, 0x47},
	"ğ»Ì²": {0x08, 0x48}, "ğ¼Ì²": {0x08, 0x49},
	
	                   "ğ½Ì²": {0x08, 0x51}, "ğ¾Ì²": {0x08, 0x52}, "ğ¿Ì²": {0x08, 0x53},
	"ğ‘€Ì²": {0x08, 0x54}, "ğ‘Ì²": {0x08, 0x55}, "ğ‘‚Ì²": {0x08, 0x56}, "ğ‘ƒÌ²": {0x08, 0x57},
	"ğ‘„Ì²": {0x08, 0x58}, "ğ‘…Ì²": {0x08, 0x59},
	
	                                      "ğ‘†Ì²": {0x08, 0x62}, "ğ‘‡Ì²": {0x08, 0x63},
	"ğ‘ˆÌ²": {0x08, 0x64}, "ğ‘‰Ì²": {0x08, 0x65}, "ğ‘ŠÌ²": {0x08, 0x66}, "ğ‘‹Ì²": {0x08, 0x67},
	"ğ‘ŒÌ²": {0x08, 0x68}, "ğ‘Ì²": {0x08, 0x69},
	
	"â—Š": {0x08, 0x71}, "âˆ§": {0x08, 0x72},                    "âŒ»": {0x08, 0x74},
	"â¸": {0x08, 0x75}, "â·": {0x08, 0x76}, "âŠ¢": {0x08, 0x77}, "âŠ£": {0x08, 0x78},
	"âˆ¨": {0x08, 0x79},
	
	"âˆ¼": {0x08, 0x80}, "â•‘": {0x08, 0x81}, "â•": {0x08, 0x82}, "â¸": {0x08, 0x83},
	"â¹": {0x08, 0x84}, "â”‚": {0x08, 0x85},
	                                      "â†‘": {0x08, 0x8a}, "â†“": {0x08, 0x8b},
	"â‰¤": {0x08, 0x8c}, "âŒˆ": {0x08, 0x8d}, "âŒŠ": {0x08, 0x8e}, "â†’": {0x08, 0x8f},
	
	"â•": {0x08, 0x90}, "â–Œ": {0x08, 0x91}, "â–": {0x08, 0x92}, "â–€": {0x08, 0x93},
	"â–„": {0x08, 0x94}, "â–ˆ": {0x08, 0x95},
	                                      "âŠƒ": {0x08, 0x9a}, "âŠ‚": {0x08, 0x9b},
	                   "â—‹": {0x08, 0x9d},                    "â†": {0x08, 0x9f},
	
	                                      "â”€": {0x08, 0xa2}, "âˆ™": {0x08, 0xa3},
	"â‚™": {0x08, 0xa4},
	                                      "âˆ©": {0x08, 0xaa}, "âˆª": {0x08, 0xab},
	"âŠ¥": {0x08, 0xac},                    "â‰¥": {0x08, 0xae}, "âˆ˜": {0x08, 0xaf},
	
	"âº": {0x08, 0xb0}, "âˆŠ": {0x08, 0xb1}, "â³": {0x08, 0xb2}, "â´": {0x08, 0xb3},
	"âµ": {0x08, 0xb4},                                       "âˆ–": {0x08, 0xb7},
	                                      "âˆ‡": {0x08, 0xba}, "âˆ†": {0x08, 0xbb},
	"âŠ¤": {0x08, 0xbc},                    "â‰ ": {0x08, 0xbe}, "âˆ£": {0x08, 0xbf},
	
	                   "â½": {0x08, 0xc1}, "âº": {0x08, 0xc2}, "â– ": {0x08, 0xc3},
	"â””": {0x08, 0xc4}, "â”Œ": {0x08, 0xc5}, "â”œ": {0x08, 0xc6}, "â”´": {0x08, 0xc7},
	                                      "â²": {0x08, 0xca}, "â±": {0x08, 0xcb},
	"âŒ·": {0x08, 0xcc}, "âŒ½": {0x08, 0xcd}, "â‚": {0x08, 0xce}, "â‰": {0x08, 0xcf},
	
	                   "â¾": {0x08, 0xd1}, "â»": {0x08, 0xd2}, "â”¼": {0x08, 0xd3},
	"â”˜": {0x08, 0xd4}, "â”": {0x08, 0xd5}, "â”¤": {0x08, 0xd6}, "â”¬": {0x08, 0xd7},
	                                      "âŒ¶": {0x08, 0xda}, "Çƒ": {0x08, 0xdb},
	"â’": {0x08, 0xdc}, "â‹": {0x08, 0xdd}, "â": {0x08, 0xde}, "â": {0x08, 0xdf},
	
	"â‰¡": {0x08, 0xe0}, "â‚": {0x08, 0xe1}, "â‚‚": {0x08, 0xe2}, "â‚ƒ": {0x08, 0xe3},
	"â¤": {0x08, 0xe4}, "â¥": {0x08, 0xe5}, "âª": {0x08, 0xe6}, "â‚¬": {0x08, 0xe7},
	                                      "âŒ¿": {0x08, 0xea}, "â€": {0x08, 0xeb},
	"âˆµ": {0x08, 0xec}, "âŠ–": {0x08, 0xed}, "âŒ¹": {0x08, 0xee}, "â•": {0x08, 0xef},
	
	"â°": {0x08, 0xf0},
	"â´": {0x08, 0xf4}, "âµ": {0x08, 0xf5}, "â¶": {0x08, 0xf6}, "â·": {0x08, 0xf7},
	"â¸": {0x08, 0xf8}, "â¹": {0x08, 0xf9},                    "â«": {0x08, 0xfb},
	"â™": {0x08, 0xfc}, "âŸ": {0x08, 0xfd}, "â": {0x08, 0xfe},
}

// Each index in this array is the EBCDIC (codepage 37) value, and the value
// at the index is the corresponding UTF-8 value.
var ebcdicDecoder = []rune{
	0x00, 0x01, 0x02, 0x03,  sub, 0x09,  sub, 0x7f,  sub,  sub,  sub, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
	0x10, 0x11, 0x12, 0x13,  sub, 0x0a, 0x08,  sub, 0x18, 0x19,  sub,  sub, 0x1c, 0x1d, 0x1e, 0x1f,
	 sub,  sub,  sub,  sub,  sub,  sub, 0x17, 0x1b,  sub,  sub,  sub,  sub,  sub, 0x05, 0x06, 0x07,
	 sub,  sub, 0x16,  sub,  sub,  sub,  sub, 0x04,  sub,  sub,  sub,  sub, 0x14, 0x15,  sub, 0x1a,
	 ' ',  'Â ',  'Ã¢',  'Ã¤',  'Ã ',  'Ã¡',  'Ã£',  'Ã¥',  'Ã§',  'Ã±',  'Â¢',  '.',  '<',  '(',  '+',  '|',
	 '&',  'Ã©',  'Ãª',  'Ã«',  'Ã¨',  'Ã­',  'Ã®',  'Ã¯',  'Ã¬',  'ÃŸ',  '!',  '$',  '*',  ')',  ';',  'Â¬',
	 '-',  '/',  'Ã‚',  'Ã„',  'Ã€',  'Ã',  'Ãƒ',  'Ã…',  'Ã‡',  'Ã‘',  'Â¦',  ',',  '%',  '_',  '>',  '?',
	 'Ã¸',  'Ã‰',  'ÃŠ',  'Ã‹',  'Ãˆ',  'Ã',  'Ã',  'Ã',  'ÃŒ',  '`',  ':',  '#',  '@', '\'',  '=',  '"',
	 'Ã˜',  'a',  'b',  'c',  'd',  'e',  'f',  'g',  'h',  'i',  'Â«',  'Â»',  'Ã°',  'Ã½',  'Ã¾',  'Â±',
	 'Â°',  'j',  'k',  'l',  'm',  'n',  'o',  'p',  'q',  'r',  'Âª',  'Âº',  'Ã¦',  'Â¸',  'Ã†',  'Â¤',
	 'Âµ',  '~',  's',  't',  'u',  'v',  'w',  'x',  'y',  'z',  'Â¡',  'Â¿',  'Ã',  'Ã',  'Ã',  'Â®',
	 '^',  'Â£',  'Â¥',  'Â·',  'Â©',  'Â§',  'Â¶',  'Â¼',  'Â½',  'Â¾',  '[',  ']',  'Â¯',  'Â¨',  'Â´',  'Ã—',
	 '{',  'A',  'B',  'C',  'D',  'E',  'F',  'G',  'H',  'I', 0xad,  'Ã´',  'Ã¶',  'Ã²',  'Ã³',  'Ãµ',
	 '}',  'J',  'K',  'L',  'M',  'N',  'O',  'P',  'Q',  'R',  'Â¹',  'Ã»',  'Ã¼',  'Ã¹',  'Ãº',  'Ã¿',
	'\\',  'Ã·',  'S',  'T',  'U',  'V',  'W',  'X',  'Y',  'Z',  'Â²',  'Ã”',  'Ã–',  'Ã’',  'Ã“',  'Ã•',
	 '0',  '1',  '2',  '3',  '4',  '5',  '6',  '7',  '8',  '9',  'Â³',  'Ã›',  'Ãœ',  'Ã™',  'Ãš', 0x9f,
}

// Each index in this array is the APL (codepage 310) value, and the value at
// the index is the corresponding UTF-8 value.
var aplDecoder = []string{
	subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS,
	subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS,
	subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS,
	subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS, subS,
	 " ",  "ğ´Ì²",  "ğµÌ²",  "ğ¶Ì²",  "ğ·Ì²",  "ğ¸Ì²",  "ğ¹Ì²",  "ğºÌ²",  "ğ»Ì²",  "ğ¼Ì²", subS, subS, subS, subS, subS, subS,
	subS,  "ğ½Ì²",  "ğ¾Ì²",  "ğ¿Ì²",  "ğ‘€Ì²",  "ğ‘Ì²",  "ğ‘‚Ì²",  "ğ‘ƒÌ²",  "ğ‘„Ì²",  "ğ‘…Ì²", subS, subS, subS, subS, subS, subS,
	subS, subS,  "ğ‘†Ì²",  "ğ‘‡Ì²",  "ğ‘ˆÌ²",  "ğ‘‰Ì²",  "ğ‘ŠÌ²",  "ğ‘‹Ì²",  "ğ‘ŒÌ²",  "ğ‘Ì²", subS, subS, subS, subS, subS, subS,
	 "â—Š",  "âˆ§",  "Â¨",  "âŒ»",  "â¸",  "â·",  "âŠ¢",  "âŠ£",  "âˆ¨", subS, subS, subS, subS, subS, subS, subS,
	 "âˆ¼",  "â•‘",  "â•",  "â¸",  "â¹",  "â”‚", subS, subS, subS, subS,  "â†‘",  "â†“",  "â‰¤",  "âŒˆ",  "âŒŠ",  "â†’",
	 "â•",  "â–Œ",  "â–",  "â–€",  "â–„",  "â–ˆ", subS, subS, subS, subS,  "âŠƒ",  "âŠ‚",  "Â¤",  "â—‹",  "Â±",  "â†",
	 "Â¯",  "Â°",  "â”€",  "âˆ™",  "â‚™", subS, subS, subS, subS, subS,  "âˆ©",  "âˆª",  "âŠ¥",  "[",  "â‰¥",  "âˆ˜",
	 "âº",  "âˆŠ",  "â³",  "â´",  "âµ", subS,  "Ã—",  "âˆ–",  "Ã·", subS,  "âˆ‡",  "âˆ†",  "âŠ¤",  "]",  "â‰ ",  "âˆ£",
	 "{",  "â½",  "âº",  "â– ",  "â””",  "â”Œ",  "â”œ",  "â”´",  "Â§", subS,  "â²",  "â±",  "âŒ·",  "âŒ½",  "â‚",  "â‰",
	 "}",  "â¾",  "â»",  "â”¼",  "â”˜",  "â”",  "â”¤",  "â”¬",  "Â¶", subS,  "âŒ¶",  "Çƒ",  "â’",  "â‹",  "â",  "â",
	 "â‰¡",  "â‚",  "â‚‚",  "â‚ƒ",  "â¤",  "â¥",  "âª",  "â‚¬", subS, subS,  "âŒ¿",  "â€",  "âˆµ",  "âŠ–",  "âŒ¹",  "â•",
	 "â°",  "Â¹",  "Â²",  "Â³",  "â´",  "âµ",  "â¶",  "â·",  "â¸",  "â¹", subS,  "â«",  "â™",  "âŸ",  "â", subS,
}

// encode converts the UTF-8 input string, u, to an EBCDIC byte array.
func encode(u string) []byte {
	var result []byte
	var lastRune *rune

	for _, r := range u {
		if lastRune != nil {
			c, ok := encoder[string([]rune{*lastRune, r})]
			lastRune = nil
			if ok {
				result = append(result, c...)
				continue
			} else {
				result = append(result, '\x3f')
			}
		}

		c, ok := encoder[string(r)]
		if ok {
			result = append(result, c...)
		} else {
			lastRune = &r
		}
	}

	if lastRune != nil {
		result = append(result, '\x3f')
	}

	return result
}

// decode converts the EBCDIC input byte array, e, to a UTF-8 string.
func decode(e []byte) string {
	var sb strings.Builder
	var apl = false
	for _, c := range e {
		if c == '\x08' {
			apl = true
			continue
		}

		if apl {
			sb.WriteString(aplDecoder[c])
			apl = false
		} else {
			sb.WriteRune(ebcdicDecoder[c])
		}
	}

	return sb.String()
}
